import telebot
from telebot import types
import random

TOKEN = "7707341525:AAGoiJELclZPTtoNw-Iv3UY9l0pcMjRsn80"
bot = telebot.TeleBot(TOKEN)

#–•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
words = {}
#–î–∞–Ω–Ω—ã–µ –∫–≤–∏–∑–∞
quiz = {}

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id,
                     "üìö –°–ª–æ–≤–∞—Ä—å!\n\n"
                     "‚Ä¢ dog: —Å–æ–±–∞–∫–∞ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å\n"
                     "‚Ä¢ ?dog - —É–∑–Ω–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ\n"
                     "‚Ä¢ +dog - –≤—ã—É—á–∏–ª ‚úì\n"
                     "‚Ä¢ -dog - —É–¥–∞–ª–∏—Ç—å\n"
                     "‚Ä¢ /my - –º–æ–∏ —Å–ª–æ–≤–∞\n"
                     "‚Ä¢ /quiz - —Ç–µ—Å—Ç!\n"
                     "‚Ä¢ /help - –ø–æ–º–æ—â—å")

@bot.message_handler(commands=['my'])
def my_words(message):
    uid = message.from_user.id
    my = words.get(uid, {})
    if not my:
        bot.send_message(message.chat.id, "–°–ª–æ–≤–∞—Ä—å –ø—É—Å—Ç")
        return

    text = "–¢–≤–æ–∏ —Å–ª–æ–≤–∞:\n\n"
    for word, info in my.items():
        mark = " ‚úì" if info["–≤—ã—É—á–µ–Ω–æ"] else " ‚úó"
        text += f"‚Ä¢ {word}: {info['–∑–Ω–∞—á–µ–Ω–∏–µ']}{mark}\n"
    bot.send_message(message.chat.id, text)

@bot.message_handler(commands=['help'])
def show_help(message):
    bot.send_message(message.chat.id,
                     "üìö –°–ª–æ–≤–∞—Ä—å - –ø–æ–º–æ—â—å**\n\n"
                     "‚Ä¢ dog: —Å–æ–±–∞–∫–∞ - –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ\n"
                     "‚Ä¢ ?dog - —É–∑–Ω–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ\n"
                     "‚Ä¢ +dog - –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã—É—á–µ–Ω–Ω—ã–º ‚úì\n"
                     "‚Ä¢ -dog - —É–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ\n\n"
                     "**–ö–æ–º–∞–Ω–¥—ã:**\n"
                     "‚Ä¢ /start - –Ω–∞—á–∞—Ç—å\n"
                     "‚Ä¢ /my - —Ç–≤–æ–∏ —Å–ª–æ–≤–∞\n"
                     "‚Ä¢ /quiz - —Ç–µ—Å—Ç –Ω–∞ 5 —Å–ª–æ–≤",
                     parse_mode="Markdown")

@bot.message_handler(commands=['quiz'])
def quiz_start(message):
    uid = message.from_user.id
    my_words = words.get(uid, {})
    unlearned = [w for w, info in my_words.items() if not info["–≤—ã—É—á–µ–Ω–æ"]]

    if not unlearned:
        bot.send_message(message.chat.id, "–í—Å–µ –≤—ã—É—á–µ–Ω–æ!")
        return

    quiz_words = random.sample(unlearned, min(5, len(unlearned)))
    quiz[uid] = {
        "—Å–ª–æ–≤–∞": quiz_words,
        "—Ç–µ–∫—É—â–∏–π": 0,
        "–ø—Ä–∞–≤–∏–ª—å–Ω–æ": 0,
        "–≤–∞—Ä–∏–∞–Ω—Ç—ã": []
    }
    show_quiz_question(message, uid)


def show_quiz_question(message, uid):
    data = quiz[uid]
    —Å–ª–æ–≤–æ = data["—Å–ª–æ–≤–∞"][data["—Ç–µ–∫—É—â–∏–π"]]
    –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–æ—Ç–≤–µ—Ç = words[uid][—Å–ª–æ–≤–æ]["–∑–Ω–∞—á–µ–Ω–∏–µ"]

    #–°–æ–∑–¥–∞–µ–º 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞
    –≤–∞—Ä–∏–∞–Ω—Ç—ã = [–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–æ—Ç–≤–µ—Ç]
    –¥—Ä—É–≥–∏–µ = [info["–∑–Ω–∞—á–µ–Ω–∏–µ"] for info in words[uid].values() if info["–∑–Ω–∞—á–µ–Ω–∏–µ"] != –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–æ—Ç–≤–µ—Ç]
    if –¥—Ä—É–≥–∏–µ:
        –≤–∞—Ä–∏–∞–Ω—Ç—ã += random.sample(–¥—Ä—É–≥–∏–µ, min(2, len(–¥—Ä—É–≥–∏–µ)))
    else:
        –≤–∞—Ä–∏–∞–Ω—Ç—ã += ["???", "???"][:2]

    random.shuffle(–≤–∞—Ä–∏–∞–Ω—Ç—ã)
    data["–≤–∞—Ä–∏–∞–Ω—Ç—ã"].append(–≤–∞—Ä–∏–∞–Ω—Ç—ã) 

    # –ö–æ—Ä–æ—Ç–∫–∏–µ callback_data: –≤—Å–µ–≥–¥–∞ <64 —Å–∏–º–≤–æ–ª–∞
    –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ = types.InlineKeyboardMarkup(row_width=1)
    for –Ω–æ–º–µ—Ä, –≤–∞—Ä–∏–∞–Ω—Ç in enumerate(–≤–∞—Ä–∏–∞–Ω—Ç—ã):
        —Ç–µ–∫—Å—Ç_–∫–Ω–æ–ø–∫–∏ = –≤–∞—Ä–∏–∞–Ω—Ç[:25] + "..." if len(–≤–∞—Ä–∏–∞–Ω—Ç) > 25 else –≤–∞—Ä–∏–∞–Ω—Ç
        cb = f"q{uid % 1000}:{data['—Ç–µ–∫—É—â–∏–π']}:{–Ω–æ–º–µ—Ä}"  # uid % 1000 = –∫–æ—Ä–æ—Ç–∫–∏–π ID
        –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞.add(types.InlineKeyboardButton(—Ç–µ–∫—Å—Ç_–∫–Ω–æ–ø–∫–∏, callback_data=cb))

    —Ç–µ–∫—Å—Ç = f"üß† –í–æ–ø—Ä–æ—Å {data['—Ç–µ–∫—É—â–∏–π'] + 1}/5\n\n{—Å–ª–æ–≤–æ}= ?"
    bot.send_message(message.chat.id, —Ç–µ–∫—Å—Ç, parse_mode="Markdown", reply_markup=–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)


@bot.callback_query_handler(func=lambda call: call.data.startswith('q'))
def quiz_answer(call):
    —á–∞—Å—Ç–∏ = call.data[1:].split(':')  # q123:0:1 ‚Üí ['123','0','1']
    uid_short = int(—á–∞—Å—Ç–∏[0])
    –≤–æ–ø—Ä–æ—Å = int(—á–∞—Å—Ç–∏[1])
    –Ω–æ–º–µ—Ä_–≤–∞—Ä–∏–∞–Ω—Ç–∞ = int(—á–∞—Å—Ç–∏[2])

    #–ù–∞—Ö–æ–¥–∏–º —Ä–µ–∞–ª—å–Ω—ã–π uid (–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–∏–∑—ã)
    uid = None
    for u, data in quiz.items():
        if data["—Ç–µ–∫—É—â–∏–π"] == –≤–æ–ø—Ä–æ—Å and (u % 1000) == uid_short:
            uid = u
            break

    if not uid or uid not in quiz:
        bot.answer_callback_query(call.id, "–ö–≤–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return

    data = quiz[uid]
    —Å–ª–æ–≤–æ = data["—Å–ª–æ–≤–∞"][–≤–æ–ø—Ä–æ—Å]
    –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π = words[uid][—Å–ª–æ–≤–æ]["–∑–Ω–∞—á–µ–Ω–∏–µ"]
    –≤–∞—Ä–∏–∞–Ω—Ç—ã = data["–≤–∞—Ä–∏–∞–Ω—Ç—ã"][–≤–æ–ø—Ä–æ—Å]
    –≤—ã–±—Ä–∞–Ω–Ω—ã–π = –≤–∞—Ä–∏–∞–Ω—Ç—ã[–Ω–æ–º–µ—Ä_–≤–∞—Ä–∏–∞–Ω—Ç–∞]
    –≤–µ—Ä–Ω–æ = –≤—ã–±—Ä–∞–Ω–Ω—ã–π == –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

    if –≤–µ—Ä–Ω–æ:
        data["–ø—Ä–∞–≤–∏–ª—å–Ω–æ"] += 1
    data["—Ç–µ–∫—É—â–∏–π"] += 1

    #–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    –∑–Ω–∞–∫ = "‚úÖ" if –≤–µ—Ä–Ω–æ else "‚ùå"
    —Ç–µ–∫—Å—Ç = f"{–∑–Ω–∞–∫}\n{—Å–ª–æ–≤–æ}** = {–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π}\n–¢–≤–æ–π –≤—ã–±–æ—Ä: {–≤—ã–±—Ä–∞–Ω–Ω—ã–π}"
    bot.edit_message_text(—Ç–µ–∫—Å—Ç, call.message.chat.id, call.message.message_id, parse_mode="Markdown")
    bot.answer_callback_query(call.id, f"{–∑–Ω–∞–∫} {'+1' if –≤–µ—Ä–Ω–æ else ''}")

    if data["—Ç–µ–∫—É—â–∏–π"] < 5:
        # –ö–Ω–æ–ø–∫–∞ –¥–∞–ª–µ–µ –≤–º–µ—Å—Ç–æ —Ç–∞–π–º–µ—Ä–∞
        –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ = types.InlineKeyboardMarkup()
        –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞.add(types.InlineKeyboardButton("‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π",
                                                  callback_data=f"n{uid % 1000}:{data['—Ç–µ–∫—É—â–∏–π']}"))
        bot.send_message(call.message.chat.id, "–ù–∞–∂–º–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:", reply_markup=–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
    else:
        –∏—Ç–æ–≥ = data["–ø—Ä–∞–≤–∏–ª—å–Ω–æ"]
        bot.send_message(call.message.chat.id,
                         f"üèÅ –ö–≤–∏–∑ –æ–∫–æ–Ω—á–µ–Ω!\n\n{–∏—Ç–æ–≥}/5 –≤–µ—Ä–Ω–æ ({–∏—Ç–æ–≥ * 20}%)\n/quiz ‚Äî –µ—â–µ —Ä–∞–∑!")
        del quiz[uid]


#–ö–Ω–æ–ø–∫–∞ –¥–∞–ª–µ–µ
@bot.callback_query_handler(func=lambda call: call.data.startswith('n'))
def next_question(call):
    —á–∞—Å—Ç–∏ = call.data[1:].split(':')
    uid_short = int(—á–∞—Å—Ç–∏[0])
    –≤–æ–ø—Ä–æ—Å = int(—á–∞—Å—Ç–∏[1])

    uid = None
    for u, data in quiz.items():
        if data["—Ç–µ–∫—É—â–∏–π"] == –≤–æ–ø—Ä–æ—Å and (u % 1000) == uid_short:
            uid = u
            break

    if uid:
        show_quiz_question(call.message, uid)


#–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
@bot.message_handler(func=lambda m: True)
def handle_message(message):
    uid = message.from_user.id
    —Ç–µ–∫—Å—Ç = message.text.strip()
    words.setdefault(uid, {})

    if —Ç–µ–∫—Å—Ç.startswith('?'):
        —Å–ª–æ–≤–æ = —Ç–µ–∫—Å—Ç[1:].strip()
        if —Å–ª–æ–≤–æ in words[uid]:
            info = words[uid][—Å–ª–æ–≤–æ]
            —Å—Ç–∞—Ç—É—Å = " ‚úì" if info["–≤—ã—É—á–µ–Ω–æ"] else " ‚úó"
            bot.reply_to(message, f"{—Å–ª–æ–≤–æ}: {info['–∑–Ω–∞—á–µ–Ω–∏–µ']}{—Å—Ç–∞—Ç—É—Å}")
        else:
            bot.reply_to(message, "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —Å–ª–æ–≤–∞")

    elif —Ç–µ–∫—Å—Ç.startswith('+'):
        —Å–ª–æ–≤–æ = —Ç–µ–∫—Å—Ç[1:].strip()
        if —Å–ª–æ–≤–æ in words[uid]:
            words[uid][—Å–ª–æ–≤–æ]["–≤—ã—É—á–µ–Ω–æ"] = True
            bot.reply_to(message, "–í—ã—É—á–µ–Ω–æ!")
        else:
            bot.reply_to(message, "–ù–µ—Ç —Å–ª–æ–≤–∞")

    elif —Ç–µ–∫—Å—Ç.startswith('-'):
        —Å–ª–æ–≤–æ = —Ç–µ–∫—Å—Ç[1:].strip()
        if —Å–ª–æ–≤–æ in words[uid]:
            words[uid].pop(—Å–ª–æ–≤–æ)
            bot.reply_to(message, "–£–¥–∞–ª–µ–Ω–æ")

    elif ':' in —Ç–µ–∫—Å—Ç:
        parts = —Ç–µ–∫—Å—Ç.split(':', 1)
        —Å–ª–æ–≤–æ = parts[0].strip()
        –∑–Ω–∞—á–µ–Ω–∏–µ = parts[1].strip()
        words[uid][—Å–ª–æ–≤–æ] = {"–∑–Ω–∞—á–µ–Ω–∏–µ": –∑–Ω–∞—á–µ–Ω–∏–µ, "–≤—ã—É—á–µ–Ω–æ": False}
        bot.reply_to(message, "–î–æ–±–∞–≤–ª–µ–Ω–æ!")

    else:
        bot.reply_to(message, "–ü–∏—à–∏: /help —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã")


print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
bot.polling()
